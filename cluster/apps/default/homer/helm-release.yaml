---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: homer
  namespace: default
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://k8s-at-home.com/charts/
      chart: homer
      version: 5.1.0
      sourceRef:
        kind: HelmRepository
        name: k8s-at-home-charts
        namespace: flux-system
  values:
    image:
      repository: b4bz/homer
      tag: 21.03.2
      pullPolicy: IfNotPresent
    ingress:
      main:
        enabled: true
        annotations:
          kubernetes.io/ingress.class: "nginx"
        hosts:
        - host: "homer.${SECRET_DOMAIN}"
          paths:
          - path: /
            pathType: Prefix
        tls:
        - hosts:
          - "homer.${SECRET_DOMAIN}"
    persistence:
      config:
        enabled: true
        existingClaim: homer-config
        mountPath: /www/assets
    initContainers:
      - name: git-sync
        image: k8s.gcr.io/git-sync-amd64:v2.0.6
        command: ["/bin/sh"]
        args: ["-c", "echo $GIT_SSH_KEY > /etc/git-secret/ssh; git-sync"]
        volumeMounts:
        - name: assets
          mountPath: /www/assets
        env:
        - name: GIT_SYNC_REPO
          value: https://github.com/Pumba98/homer-config
        - name: GIT_SYNC_BRANCH
          value: master
        - name: GIT_SYNC_ROOT
          value: /
        - name: GIT_SYNC_DEST
          value: /www/assets
        - name: GIT_SYNC_PERMISSIONS
          value: "0777"
        - name: GIT_SYNC_ONE_TIME
          value: "true"
        - name: GIT_SYNC_SSH
          value: "true"
        - name: GIT_SSH_KEY
          value: ${SECRET_HOMER_SSH}
        securityContext:
          runAsUser: 0